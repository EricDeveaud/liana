---
title: "LIANA Customize CCC OmniPath"
author:
  - name: Daniel Dimitrov
    affiliation:
        - Saezlab, Heidelberg University
    email: daniel.dimitrov@uni-heidelberg.de
date: "04/08/2021"
output: 
  BiocStyle::html_document:
      self_contained: true
      toc: true
      toc_float: true
      toc_depth: 3
      code_folding: show
---

# Customize CCC OmniPath
This vignette showcases how to customize the OmniPath according to different
inbuilt filter options and additional information from OmniPath, as well as 
how to use `liana` with the customized resource.

#### Load Prerequisites
```{r load_prereq, message=FALSE, warning=FALSE}
require(liana)
require(tibble)
require(purrr)
require(magrittr)

liana_path <- system.file(package = "liana")
testdata <-
    readRDS(file.path(liana_path , "testdata", "input", "testdata.rds"))
```

## OmniPath as in the manuscript

We will first filter OmniPath as described in the LIANA paper:
* we retained only interactions with literature references,
* we kept interactions only where the receiver protein was plasma membrane transmembrane
or peripheral according to at least 30% of the localisation annotations
* we considered only interactions between single proteins (interactions between complexes are also available in OmniPath).
```{r liana_omni}
# generate_omni returns a tibble with CCC OmniPath
cust_omni <- generate_omni(loc_consensus_percentile = 30,
                           consensus_percentile = NULL,
                           transmitter_topology = c('secreted',
                                                    'plasma_membrane_transmembrane',
                                                    'plasma_membrane_peripheral'),
                           receiver_topology = c('plasma_membrane_transmembrane',
                                                 'plasma_membrane_peripheral'),
                           min_curation_effort = 1,
                           ligrecextra = FALSE,
                           remove_complexes = TRUE,
                           simplify = FALSE
                           )

liana_omni <- select_resource("OmniPath")[[1]]

# Check if the same
all_equal(op_omni, liana_omni)
```


## Surface/Membrane-bound Interactions only
```{r pm_omni}
pm_omni <- 
  generate_omni(loc_consensus_percentile = 51, # increase localisation consensus threshold
                consensus_percentile = NULL,
                # include only PM-bound proteins
                transmitter_topology = c('plasma_membrane_transmembrane',
                                         'plasma_membrane_peripheral'),
                receiver_topology = c('plasma_membrane_transmembrane',
                                      'plasma_membrane_peripheral'),
                min_curation_effort = 1,
                ligrecextra = FALSE,
                remove_complexes = FALSE, # keep complexes
                simplify = TRUE # do simplify
)


# check categories of ligands (category_intercell_source)
pm_omni$category_intercell_source %>% unique()

# and receptors (category_intercell_target)
pm_omni$category_intercell_target %>% unique()

# remove these categories
pm_omni %<>% filter(!(category_intercell_source %in% c("activating_cofactor",
                                                       "ligand_regulator",
                                                       "inhibitory_cofactor")))
# glimpse into the PM
pm_omni %>% glimpse()
```

## Run LIANA with custom CCC resource

#### RUN liana
```{r liana_wrap}
# Run liana with the custom resource
# liana Wrap
liana_test <- liana_wrap(seurat_object = testdata,
                         resource='custom',
                         external_resource = pm_omni,
                         cellchat.params=list(.normalize=TRUE)) %>%
  liana_aggregate()

liana_test %>% glimpse
```
