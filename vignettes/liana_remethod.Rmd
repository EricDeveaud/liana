---
title: "LIANA Re-implemented Methods"
author:
  - name: Daniel Dimitrov
    affiliation:
        - Saezlab, Heidelberg University
    email: daniel.dimitrov@uni-heidelberg.de
date: "03/08/2021"
output: 
  BiocStyle::html_document:
      self_contained: true
      toc: true
      toc_float: true
      toc_depth: 3
      code_folding: show
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```



# `liana`: Method re-implementation

Cell-cell communication often relies on multi-subunit protein complexes and several datasets were incorporate such information (such as [CellPhoneDB](https://www.nature.com/articles/s41596-020-0292-x), [ICELLNET](https://www.nature.com/articles/s41467-021-21244-x), [Baccin2019](https://www.nature.com/articles/s41556-019-0439-6), and [CellChatDB](https://www.nature.com/articles/s41467-021-21246-9)). To leverage this information in a similar way to [CellChatDB](https://www.nature.com/articles/s41467-021-21246-9)) and the [CellPhoneDB](https://www.nature.com/articles/s41596-020-0292-x), we have developed the architecture in liana to account for complex subunits.

This is particularly relevant for the measures introduced by [`SingleCellSignalR (sca)`], [`NATMI`], and [`Connectome`], as the original implementations of these methods were not developed to take complexes into account.

As such, in this vignette we will compare the liana re-implementation of these methods with toy data.


#### Load Prerequisites
```{r load_prereq, message=FALSE, warning=FALSE}
require(liana)
require(tibble)
require(purrr)
require(magrittr)

liana_path <- system.file(package = "liana")
testdata <-
    readRDS(file.path(liana_path , "testdata", "input", "testdata.rds"))
```

## Connectome weights
```{r conectome_run, message = FALSE, print = FALSE}
# Run liana /w re-implemented and original Connectome
connectome_test <- liana_wrap(testdata,
                              method = c('call_connectome', 'connectome'),
                              resource = c('OmniPath'))

# compare results
connectome_test %<>% 
    map(function(conn)
        conn %>%
            select(source, target, ligand, receptor, weight_sc) %>%
            arrange_at(vars(everything()))
            ) %>%
    liana_aggregate()

connectome_test %>%
    mutate_at(.vars = c("call_connectome.weight_sc", "connectome.weight_sc"),
              round, digits = 5) %>% # account for different rounding
    filter(call_connectome.weight_sc!=connectome.weight_sc) # keep only different

```


## NATMI edges
```{r natmi_run, message = FALSE, print = FALSE}
# Run liana /w re-implemented and original NATMI
natmi_test <- liana_wrap(testdata,
                         method = c('call_natmi', 'natmi'),
                         resource = c('OmniPath'),
                         call_natmi.params = list(.use_raw = TRUE))

# compare results
natmi_test %<>% 
    map(function(res)
        res %>%
            select(source, target, ligand, receptor, edge_specificity) %>%
            arrange_at(vars(everything()))
            ) %>%
    liana_aggregate() %>%
    na.omit() # remove NAs (as these are treated differently, filtered in NATMI, assigned 0s in LIANA)

natmi_test %>%
    mutate_at(.vars = c("call_natmi.edge_specificity", "natmi.edge_specificity"),
              round, digits = 5) %>%
    filter(call_natmi.edge_specificity!=natmi.edge_specificity) # keep only different

```


## SingleCellSignalR LRscore
```{r sca_run, message = FALSE, print = FALSE}
# Run liana /w re-implemented and original SCA
sca_test <- liana_wrap(testdata,
                       method = c('call_sca', 'sca'),
                       resource = c('OmniPath'))

# compare results
sca_test %<>% 
    map(function(res)
        res %>%
            select(source, target, ligand, receptor, LRscore) %>%
            arrange_at(vars(everything()))
        ) %>%
    liana_aggregate()

sca_test %<>%
    mutate_at(.vars = c("call_sca.LRscore", "sca.LRscore"),
              round, digits = 5)  %>% # account for different rounding
    na.omit() # exclude auto-regulation and filtered interactions
    
sca_test %>%
    dplyr::filter(call_sca.LRscore!=sca.LRscore) # show only different
```


## SingleCellSignalR, NATMI, and Connectome Scores /w Complexes (CellPhoneDB)
```{r sca_run, message = FALSE, print = FALSE}
# Run liana /w re-implemented and original SCA
complex_test <- liana_wrap(testdata,
                           method = c('natmi', 'sca', 'logfc', 'connectome'),
                           resource = c('CellPhoneDB'))

complex_test
```

